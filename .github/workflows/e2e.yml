name: E2E Tests

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with debug logging'
        required: false
        default: false

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CARGO_INCREMENTAL: 0

jobs:
  e2e-rust:
    name: Rust E2E Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            shell_tests: true
          - os: macos-latest
            shell_tests: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Create test directories
        run: mkdir -p test-logs/artifacts test-results

      - name: Build project
        run: cargo build --features test-utils
        env:
          RUST_LOG: ${{ inputs.debug_enabled && 'debug' || 'info' }}

      - name: Run Rust E2E tests
        run: |
          cargo nextest run \
            --features test-utils \
            --test e2e_usage_test \
            --test e2e_cost_test \
            --no-fail-fast \
            --test-threads=2 \
            --profile ci \
            2>&1 | tee test-logs/e2e_rust_${{ matrix.os }}.log
        env:
          RUST_LOG: ${{ inputs.debug_enabled && 'debug' || 'info' }}
          RUST_BACKTRACE: 1
          NO_COLOR: 1
        continue-on-error: true
        id: rust_e2e

      - name: Run shell E2E tests
        if: matrix.shell_tests
        run: |
          echo "=== Running Shell E2E Tests ===" | tee test-logs/e2e_shell_${{ matrix.os }}.log
          echo "" >> test-logs/e2e_shell_${{ matrix.os }}.log

          # Run cost E2E tests
          if [ -f tests/e2e/test_cost.sh ]; then
            echo "--- test_cost.sh ---" | tee -a test-logs/e2e_shell_${{ matrix.os }}.log
            chmod +x tests/e2e/test_cost.sh
            bash tests/e2e/test_cost.sh 2>&1 | tee -a test-logs/e2e_shell_${{ matrix.os }}.log || echo "test_cost.sh failed with exit code $?"
            echo "" >> test-logs/e2e_shell_${{ matrix.os }}.log
          fi

          # Run usage E2E tests
          if [ -f tests/e2e/test_usage.sh ]; then
            echo "--- test_usage.sh ---" | tee -a test-logs/e2e_shell_${{ matrix.os }}.log
            chmod +x tests/e2e/test_usage.sh
            bash tests/e2e/test_usage.sh 2>&1 | tee -a test-logs/e2e_shell_${{ matrix.os }}.log || echo "test_usage.sh failed with exit code $?"
          fi
        env:
          NO_COLOR: 1
          CAUT_LOG_LEVEL: ${{ inputs.debug_enabled && 'debug' || 'info' }}
        continue-on-error: true
        id: shell_e2e

      - name: Collect performance metrics
        if: always()
        run: |
          echo "=== Performance Metrics ===" > test-logs/metrics_${{ matrix.os }}.log
          echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-logs/metrics_${{ matrix.os }}.log
          echo "OS: ${{ matrix.os }}" >> test-logs/metrics_${{ matrix.os }}.log
          echo "" >> test-logs/metrics_${{ matrix.os }}.log

          # Binary size
          if [ -f target/debug/caut ]; then
            echo "Binary size (debug): $(ls -lh target/debug/caut | awk '{print $5}')" >> test-logs/metrics_${{ matrix.os }}.log
          fi

          # Build time approximation from cargo output
          echo "" >> test-logs/metrics_${{ matrix.os }}.log
          echo "Build completed successfully" >> test-logs/metrics_${{ matrix.os }}.log

      - name: Generate test summary
        if: always()
        run: |
          echo "## E2E Test Results - ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Rust test results
          echo "### Rust E2E Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f test-logs/e2e_rust_${{ matrix.os }}.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 test-logs/e2e_rust_${{ matrix.os }}.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No Rust test log found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Shell test results
          echo "### Shell E2E Tests" >> $GITHUB_STEP_SUMMARY
          if [ -f test-logs/e2e_shell_${{ matrix.os }}.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 test-logs/e2e_shell_${{ matrix.os }}.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "Shell tests not run on this platform" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Performance metrics
          echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
          if [ -f test-logs/metrics_${{ matrix.os }}.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-logs/metrics_${{ matrix.os }}.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-${{ matrix.os }}
          path: |
            test-logs/
          retention-days: 14

      - name: Upload JUnit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-junit-${{ matrix.os }}
          path: |
            test-results/
          retention-days: 14
          if-no-files-found: ignore

      - name: Check test results
        if: always()
        run: |
          if [ "${{ steps.rust_e2e.outcome }}" == "failure" ] || [ "${{ steps.shell_e2e.outcome }}" == "failure" ]; then
            echo "::error::E2E tests failed"
            exit 1
          fi

  e2e-windows:
    name: Rust E2E Tests (windows-latest)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Create test directories
        run: |
          New-Item -ItemType Directory -Force -Path test-logs
          New-Item -ItemType Directory -Force -Path test-results
        shell: pwsh

      - name: Build project
        run: cargo build --features test-utils
        env:
          RUST_LOG: info

      - name: Run Rust E2E tests
        run: |
          cargo nextest run `
            --features test-utils `
            --test e2e_usage_test `
            --test e2e_cost_test `
            --no-fail-fast `
            --test-threads=2 `
            --retries 1 `
            2>&1 | Tee-Object -FilePath test-logs/e2e_rust_windows.log
        shell: pwsh
        env:
          RUST_LOG: info
          RUST_BACKTRACE: 1
          NO_COLOR: 1
        continue-on-error: true
        id: rust_e2e

      - name: Generate test summary
        if: always()
        run: |
          "## E2E Test Results - Windows" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          "### Rust E2E Tests" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          if (Test-Path "test-logs/e2e_rust_windows.log") {
            "``````" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
            Get-Content "test-logs/e2e_rust_windows.log" -Tail 100 | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
            "``````" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          }
        shell: pwsh

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-windows
          path: |
            test-logs/
          retention-days: 14

      - name: Check test results
        if: always()
        run: |
          if ("${{ steps.rust_e2e.outcome }}" -eq "failure") {
            Write-Error "E2E tests failed"
            exit 1
          }
        shell: pwsh

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-rust, e2e-windows]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate combined summary
        run: |
          echo "# E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Ubuntu | ${{ needs.e2e-rust.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.e2e-rust.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.e2e-windows.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test logs and JUnit XML results are available as workflow artifacts." >> $GITHUB_STEP_SUMMARY

          # List available artifacts
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Logs" >> $GITHUB_STEP_SUMMARY
          find artifacts -name "*.log" -type f 2>/dev/null | while read f; do
            echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY
          done || echo "No log files found" >> $GITHUB_STEP_SUMMARY

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-all-artifacts
          path: artifacts/
          retention-days: 14
